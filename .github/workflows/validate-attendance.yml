# Yoklama PR'larÄ±nÄ± DoÄŸrulama Workflow'u
name: Validate Attendance PR

on:
  pull_request:
    paths:
      - 'attendance/**'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-attendance:
    name: ğŸ›¡ï¸ Yoklama KontrolÃ¼
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” DeÄŸiÅŸiklikleri Analiz Et
        id: check_changes
        run: |
          echo "ğŸ” Yoklama dosyalarÄ± kontrol ediliyor..."
          
          # DeÄŸiÅŸen dosyalarÄ± listele
          base_sha=${{ github.event.pull_request.base.sha }}
          head_sha=${{ github.event.pull_request.head.sha }}
          
          # Hangi dosyalar deÄŸiÅŸmiÅŸ?
          git diff --name-status $base_sha $head_sha -- attendance/ > changes.txt
          cat changes.txt
          
          # 1. GÃœVENLÄ°K KONTROLÃœ: Silinen veya deÄŸiÅŸtirilen dosya var mÄ±?
          # M: Modified, D: Deleted
          if grep -q -E "^(M|D)" changes.txt; then
            echo "âŒ HATA: Mevcut yoklama dosyalarÄ±nÄ± deÄŸiÅŸtiremez veya silemezsiniz!"
            echo "Security violation detected: Modification or deletion of existing attendance files."
            echo "security_violation=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # 2. YENÄ° DOSYA KONTROLÃœ: Sadece yeni dosya eklenmeli
          # A: Added
          ADDED_FILES=$(grep "^A" changes.txt | awk '{print $2}')
          
          if [ -z "$ADDED_FILES" ]; then
            echo "âš ï¸ UYARI: Yeni bir yoklama dosyasÄ± eklenmemiÅŸ gÃ¶rÃ¼nÃ¼yor."
            echo "no_new_file=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "files=$ADDED_FILES" >> $GITHUB_OUTPUT
          
      - name: ğŸ“§ E-posta ve Format KontrolÃ¼
        if: success()
        id: validate_content
        run: |
          echo "ğŸ” Dosya iÃ§eriÄŸi ve formatÄ± kontrol ediliyor..."
          
          FILES="${{ steps.check_changes.outputs.files }}"
          EMAIL_PATTERN='^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
          
          for file in $FILES; do
            echo "Checking file: $file"
            
            # Ä°Ã§erik kontrolÃ¼ (Sadece e-posta olmalÄ±)
            CONTENT=$(cat "$file" | tr -d '[:space:]')
            
            if [[ ! "$CONTENT" =~ $EMAIL_PATTERN ]]; then
              echo "âŒ HATA: $file iÃ§eriÄŸi geÃ§erli bir e-posta adresi deÄŸil!"
              echo "Expected format: ogrenci_no@ogr.cbu.edu.tr"
              echo "Found: $CONTENT"
              exit 1
            fi
            
            # Dosya ismi kontrolÃ¼
            FILENAME=$(basename "$file" .txt)
            FILENAME=$(basename "$FILENAME" .md) # .md uzantÄ±sÄ±nÄ± da kabul edelim
            
            # E-postanÄ±n kullanÄ±cÄ± adÄ± kÄ±smÄ±nÄ± al ( @ iÅŸaretinden Ã¶ncesi)
            EMAIL_USER=$(echo "$CONTENT" | cut -d'@' -f1)
            
            # 3. KURAL: Dosya adÄ± ile E-posta kullanÄ±cÄ±sÄ± BÄ°REBÄ°R aynÄ± olmalÄ±
            # Ã–rn: Dosya: 210316011.txt -> Ä°Ã§erik: 210316011@ogr.cbu.edu.tr
            if [[ "$FILENAME" != "$EMAIL_USER" ]]; then
               echo "âŒ HATA: Dosya ismi ile e-posta adresi uyuÅŸmuyor!"
               echo "Dosya AdÄ±: $FILENAME"
               echo "E-posta KullanÄ±cÄ±sÄ±: $EMAIL_USER"
               echo "LÃ¼tfen dosya adÄ±nÄ±zÄ± Ã¶ÄŸrenci numaranÄ±zla aynÄ± yapÄ±n."
               exit 1
            fi
            
            echo "âœ… $file geÃ§erli!"
          done
          
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: âœ… BaÅŸarÄ±lÄ± - Yorum Ekle
        if: steps.validate_content.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… Yoklama BaÅŸarÄ±lÄ±!

            DosyanÄ±z ve e-posta formatÄ±nÄ±z doÄŸrulandÄ±. Ä°ÅŸbirliÄŸi iÃ§in teÅŸekkÃ¼rler! ğŸ‰

            ---
            *Github Workshop Bot* ğŸ¤–`
            })

      - name: âŒ GÃ¼venlik HatasÄ± - Yorum Ekle
        if: failure() && steps.check_changes.outputs.security_violation == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## â›” GÃ¼venlik UyarÄ±sÄ±

            **BaÅŸka bir Ã¶ÄŸrencinin dosyasÄ±nÄ± deÄŸiÅŸtirmeye veya silmeye Ã§alÄ±ÅŸtÄ±nÄ±z!** 
            
            Bu iÅŸlem yasaktÄ±r. LÃ¼tfen sadece kendi dosyanÄ±zÄ± eklediÄŸiniz yeni bir PR aÃ§Ä±n.

            ---
            *Github Workshop Bot* ğŸ¤–`
            })
            
      - name: âŒ Format HatasÄ± - Yorum Ekle
        if: failure() && steps.check_changes.outputs.security_violation != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Format HatasÄ±

            LÃ¼tfen ÅŸunlara dikkat edin:
            1. \`attendance/\` klasÃ¶rÃ¼ iÃ§ine **yeni bir dosya** oluÅŸturun.
            2. Dosya adÄ± Ã¶ÄŸrenci numaranÄ±z olsun (Ã¶rn: \`210316011.txt\`).
            3. Dosya iÃ§eriÄŸinde **sadece** e-posta adresiniz olsun.
            4. **Ã–NEMLÄ°:** Dosya adÄ± ile e-posta adresindeki numara aynÄ± olmalÄ±dÄ±r!

            Format:
            \`ogrenci_no@ogr.cbu.edu.tr\`

            ---
            *Github Workshop Bot* ğŸ¤–`
            })
